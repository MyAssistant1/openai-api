<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flask Ses Kayıt</title>
</head>
<body>

<h1>Flask Ses Kayıt Uygulaması</h1>

<button onclick="startRecording()">Kaydı Başlat</button>
<button onclick="stopRecording()">Kaydı Bitir</button>
<p id="timer">Geçen Süre: 0 saniye</p>

<audio id="audioPlayer" controls></audio>

<style>
.balloon {
            display: inline-block;
            background-color: #4CAF50; /* Yeşil renk */
            color: white; /* Yazı rengi */
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            max-width: 100%; /* Maksimum genişlik */
            word-wrap: break-word; /* Uzun kelimeleri kır */
        }
</style>
<div id="resultDiv" class="balloon"></div>

<script>

//import DOWNLOADPATH from './constant.py' ;
let mediaRecorder;
let audioChunks = [];
let timerInterval;
let elapsedTime = 0;

function startRecording() {
    
    // Önceki kaydı durdur
    stopRecording();

    navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
            mediaRecorder = new MediaRecorder(stream);

            mediaRecorder.ondataavailable = event => {
                if (event.data.size > 0) {
                    audioChunks.push(event.data);
                }
            };

            mediaRecorder.onstop = () => {
    // Blob'u oluştur
    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });

    // Blob'u çalınabilir bir formata dönüştürmek için kullanılan Audio elementi
    const audioPlayer = new Audio();
    audioPlayer.src = URL.createObjectURL(audioBlob);
    audioPlayer.controls = true; // Kontrolleri göster

    // Kaydedilen ses dosyasını dinlemek için yeni bir pencere aç
    const popupWindow = window.open('', '_blank');
    popupWindow.document.body.appendChild(audioPlayer);

    // Anchor (a) elementi oluştur
    const link = document.createElement("a");
    link.href = audioPlayer.src;
    link.download = 'recorded_audio.webm';

    // Sayfaya ekleyip simüle edilen tıklamayı tetikle
    document.body.appendChild(link);
    link.click();

    // Kullanıldıktan sonra elemanları temizle
    document.body.removeChild(link);
    popupWindow.close();

    // Blob URL'sini serbest bırak
    URL.revokeObjectURL(audioPlayer.src);

    // Upload metodunu çağır
    uploadAudio(audioBlob);
};

            mediaRecorder.start();
            timerInterval = setInterval(updateTimer, 1000);
        })
        .catch(error => {
            console.error('Hata:', error);
        });
}

function stopRecording() {
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        clearInterval(timerInterval); // Kayıt durduğunda timer'ı temizle
    }
}

function uploadAudio(blob) {

     // Sunucuya POST isteği gönder
     fetch('/upload', {
        method: 'POST',
    })
    .then(response => response.text())
    .then(data => {
        console.log('Server response:', data);
        data = data + '\n';

        // Sonucu bir baloncuk içinde göster
        const resultDiv = document.getElementById('resultDiv');
        resultDiv.innerText =  data;
        resultDiv.classList.add('balloon'); // Baloncuk stili için sınıf ekleyin
    })
    .catch(error => {

        console.error('Error:', error);
        error.message = error.message + '\n';

        // Hata mesajını bir baloncuk içinde göster
        const resultDiv = document.getElementById('resultDiv');
        resultDiv.innerText = 'Error: ' + error.message;
        resultDiv.classList.add('balloon'); // Baloncuk stili için sınıf ekleyin
    });

    audioChunks = []; // Önceki kaydı temizle
    elapsedTime = 0; // Süreyi sıfırla
    document.getElementById('timer').innerText = 'Geçen Süre: 0 saniye'; // Süre gösterimini sıfırla
}

function updateTimer() {
    elapsedTime += 1;
    document.getElementById('timer').innerText = 'Geçen Süre: ' + elapsedTime + ' saniye';
}



</script>
